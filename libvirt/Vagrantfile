# Kubernetes Multi-Node Cluster with Vagrant and libvirt
# Optimized for Debian host with virt-manager/KVM

NUM_WORKER_NODES = 2
IP_BASE = "192.168.56."
CONTROL_PLANE_IP = "#{IP_BASE}10"

# Box configuration
BOX_NAME = "generic/ubuntu2204"
BOX_VERSION = "4.3.12"  # Pin version for consistency

Vagrant.configure("2") do |config|
  # Global VM configuration
  config.vm.box = BOX_NAME
  config.vm.box_version = BOX_VERSION
  config.vm.box_check_update = false

  # Shared folder for join command (using rsync for better compatibility)
  config.vm.synced_folder ".", "/vagrant",
    type: "rsync",
    rsync__auto: false,
    rsync__exclude: [".git/", "*.log"]

  # Global libvirt configuration
  config.vm.provider :libvirt do |v|
    v.driver = "kvm"
    v.disk_bus = "virtio"
    v.nic_model_type = "virtio"
    v.video_type = "virtio"
    v.sound_type = nil
    v.channel :type => 'unix', :target_name => 'org.qemu.guest_agent.0', :target_type => 'virtio'
    v.random :model => 'random'
    v.cpu_mode = "host-passthrough"  # Better performance on Debian/KVM
    v.nested = true
    v.graphics_type = "none"  # Headless
  end

  # Common provisioning for all nodes
  config.vm.provision "shell",
    name: "common-setup",
    inline: <<-SHELL
      #!/bin/bash
      set -euo pipefail

      # Export non-interactive frontend
      export DEBIAN_FRONTEND=noninteractive

      # Source the common setup script
      bash /vagrant/scripts/common.sh
    SHELL

  # Control Plane Node
  config.vm.define "controlplane", primary: true do |cp|
    cp.vm.hostname = "controlplane"
    cp.vm.network "private_network",
      ip: CONTROL_PLANE_IP,
      libvirt__network_name: "k8s-network",
      libvirt__dhcp_enabled: false,
      libvirt__forward_mode: "nat"

    cp.vm.provider :libvirt do |v|
      v.memory = 4096
      v.cpus = 2
      v.machine_type = "q35"  # Modern machine type
    end

    # Initialize control plane
    cp.vm.provision "shell",
      name: "init-controlplane",
      path: "scripts/controlplane.sh",
      args: CONTROL_PLANE_IP,
      env: {"DEBIAN_FRONTEND" => "noninteractive"}
  end

  # Worker Nodes
  (1..NUM_WORKER_NODES).each do |i|
    config.vm.define "worker#{i}" do |worker|
      worker.vm.hostname = "worker#{i}"
      worker.vm.network "private_network",
        ip: "#{IP_BASE}#{10+i}",
        libvirt__network_name: "k8s-network",
        libvirt__dhcp_enabled: false,
        libvirt__forward_mode: "nat"

      worker.vm.provider :libvirt do |v|
        v.memory = 4096
        v.cpus = 2
        v.machine_type = "q35"
      end

      # Join worker to cluster
      worker.vm.provision "shell",
        name: "join-worker",
        path: "scripts/worker.sh",
        args: CONTROL_PLANE_IP,
        env: {"DEBIAN_FRONTEND" => "noninteractive"}
    end
  end
end
